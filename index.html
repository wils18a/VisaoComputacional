<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SMC | Smart Vision Firebase</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --smc-blue: #00529B;
            --smc-dark: #003366;
            --bg-body: #F0F2F5;
            --surface: #FFFFFF;
            --status-ok: #28A745;
            --border: #DEE2E6;
            --shadow: 0 2px 4px rgba(0,0,0,0.08);
            --radius: 6px;
        }

        html, body {
            height: 100vh; width: 100vw; margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: #212529; font-family: 'Inter', sans-serif;
            display: flex; flex-direction: column; overflow: hidden;
        }

        header {
            background: var(--surface);
            border-bottom: 3px solid var(--smc-blue);
            padding: 0.5rem 1rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow);
            flex: 0 0 auto;
        }

        .logo-container { display: flex; align-items: center; gap: 10px; }
        .logo-smc { height: 22px; }
        .header-title { font-size: 0.85rem; font-weight: 700; color: var(--smc-blue); text-transform: uppercase; }

        main {
            flex: 1; display: flex; flex-direction: column;
            padding: 8px; gap: 8px; box-sizing: border-box;
            height: calc(100vh - 50px);
        }

        .card {
            background: var(--surface); border-radius: var(--radius);
            box-shadow: var(--shadow); border: 1px solid var(--border);
            display: flex; flex-direction: column; 
            flex: 1; overflow: hidden;
        }

        .card-header {
            padding: 6px 12px; background: #F8F9FA;
            border-bottom: 1px solid var(--border);
            flex: 0 0 auto;
        }

        .card-title { font-size: 0.7rem; font-weight: 700; color: var(--smc-dark); text-transform: uppercase; }

        .telemetry-inline {
            display: flex; gap: 15px; margin-top: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem; font-weight: 700; color: var(--smc-blue);
        }
        .telemetry-label { font-size: 0.6rem; color: #666; margin-right: 4px; text-transform: uppercase; }

        .card-body { 
            flex: 1; position: relative; display: flex; 
            justify-content: center; align-items: center; background: #000;
            overflow: hidden;
        }

        canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        #videoInput { position: absolute; opacity: 0; pointer-events: none; }

        .p-badge { 
            padding: 1px 5px; border-radius: 4px; background: #e9ecef; 
            color: #666; border: 1px solid #ced4da; font-size: 0.55rem; 
            font-family: 'JetBrains Mono'; float: right;
        }
    </style>
</head>

<body>

    <header>
        <div class="logo-container">
            <img src="https://webmachines.com.br/uploads/produtos/580/614ccbd704751.png" alt="SMC" class="logo-smc">
            <span class="header-title">Vision to Firebase</span>
        </div>
        <div id="db-status" class="header-title" style="font-size: 0.6rem; color: #666;">DB: IDLE</div>
    </header>

    <main>
        <div class="card">
            <div class="card-header">
                <span class="p-badge">SENSOR: PT-01</span>
                <span class="card-title">Live Edge Analytics</span>
            </div>
            <div class="card-body">
                <video id="videoInput" playsinline webkit-playsinline muted></video>
                <canvas id="canvasOutput"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="p-badge">FIREBASE: PT1/PT2</span>
                <span class="card-title">Trajectory Mapping (X-Y Axis)</span>
                
                <div class="telemetry-inline">
                    <div><span class="telemetry-label">X:</span><span id="val-x">000</span></div>
                    <div><span class="telemetry-label">Y:</span><span id="val-y">000</span></div>
                    <div id="status-detect" style="font-size: 0.65rem; color: var(--status-ok); margin-left: auto;">SCANNING...</div>
                </div>
            </div>
            <div class="card-body" style="background: #FFFFFF;">
                <canvas id="graphCanvas"></canvas>
            </div>
        </div>
    </main>

    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>

    <script>
        const FIREBASE_URL = "https://smci40-default-rtdb.firebaseio.com/SMC_i40_4.json";
        
        let video = document.getElementById('videoInput');
        let canvasOutput = document.getElementById('canvasOutput');
        let graphCanvas = document.getElementById('graphCanvas');
        let ctxGraph = graphCanvas.getContext('2d');
        let dbStatus = document.getElementById('db-status');
        
        let src, gray, circles, cap;
        let streaming = false;
        let historyX = [], historyY = [];
        const MOVING_AVG_SIZE = 6;
        let lastPosX = null, lastPosY = null;
        let lastResetTime = Date.now();
        let lastFirebaseTime = Date.now();

        function onOpenCvReady() {
            startCamera();
        }

        async function sendToFirebase(x, y) {
            try {
                // Envia X para PT1 e Y para PT2 conforme solicitado
                const data = { PT1: Math.round(x), PT2: Math.round(y) };
                
                const response = await fetch(FIREBASE_URL, {
                    method: 'PATCH', // PATCH atualiza apenas PT1 e PT2 sem apagar outros dados no nÃ³
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    dbStatus.innerText = "DB: UPDATED";
                    dbStatus.style.color = "#28A745";
                }
            } catch (error) {
                console.error("Firebase Error:", error);
                dbStatus.innerText = "DB: OFFLINE";
                dbStatus.style.color = "#DC3545";
            }
        }

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 640, height: 480 }, 
                audio: false 
            })
            .then(stream => {
                video.srcObject = stream;
                video.play();
            });

            video.addEventListener("playing", () => {
                if (!streaming) initProcessor();
            });
        }

        function initProcessor() {
            const w = video.videoWidth;
            const h = video.videoHeight;
            video.width = w; video.height = h;
            canvasOutput.width = w; canvasOutput.height = h;
            graphCanvas.width = w; graphCanvas.height = h;

            src = new cv.Mat(h, w, cv.CV_8UC4);
            gray = new cv.Mat(h, w, cv.CV_8UC1);
            circles = new cv.Mat();
            cap = new cv.VideoCapture(video);

            clearGraph();
            streaming = true;
            requestAnimationFrame(processFrame);
        }

        function clearGraph() {
            const w = graphCanvas.width;
            const h = graphCanvas.height;
            ctxGraph.fillStyle = "#FFFFFF";
            ctxGraph.fillRect(0, 0, w, h);
            ctxGraph.strokeStyle = "#000000";
            ctxGraph.lineWidth = 1;
            ctxGraph.font = "bold 10px 'JetBrains Mono'";
            ctxGraph.fillStyle = "#00529B";

            for (let i = 0; i <= h; i += h/4) {
                ctxGraph.beginPath(); ctxGraph.moveTo(0, i); ctxGraph.lineTo(w, i); ctxGraph.stroke();
                ctxGraph.fillText(Math.round(i), 5, i - 5);
            }
            for (let i = 0; i <= w; i += w/4) {
                ctxGraph.beginPath(); ctxGraph.moveTo(i, 0); ctxGraph.lineTo(i, h); ctxGraph.stroke();
                ctxGraph.fillText(Math.round(i), i + 5, h - 5);
            }
            lastPosX = null; lastPosY = null;
        }

        function processFrame() {
            if (!streaming) return;
            try {
                cap.read(src);
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                cv.medianBlur(gray, gray, 7);
                cv.HoughCircles(gray, circles, cv.HOUGH_GRADIENT, 1.2, 100, 150, 55, 10, 200);

                cv.imshow("canvasOutput", src);
                let ctxVideo = canvasOutput.getContext("2d");

                if (circles.cols > 0) {
                    let rawX = circles.data32F[0];
                    let rawY = circles.data32F[1];
                    let radius = circles.data32F[2];

                    historyX.push(rawX); historyY.push(rawY);
                    if (historyX.length > MOVING_AVG_SIZE) { historyX.shift(); historyY.shift(); }

                    let avgX = historyX.reduce((a, b) => a + b) / historyX.length;
                    let avgY = historyY.reduce((a, b) => a + b) / historyY.length;

                    document.getElementById('val-x').innerText = Math.round(avgX).toString().padStart(3, '0');
                    document.getElementById('val-y').innerText = Math.round(avgY).toString().padStart(3, '0');
                    document.getElementById('status-detect').innerText = "TRACKING ACTIVE";
                    document.getElementById('status-detect').style.color = "#28A745";

                    ctxVideo.beginPath();
                    ctxVideo.arc(avgX, avgY, radius, 0, Math.PI * 2);
                    ctxVideo.strokeStyle = "#28A745";
                    ctxVideo.lineWidth = 4;
                    ctxVideo.stroke();

                    if (lastPosX !== null) {
                        ctxGraph.beginPath();
                        ctxGraph.moveTo(lastPosX, lastPosY);
                        ctxGraph.lineTo(avgX, avgY);
                        ctxGraph.strokeStyle = "#FF0000";
                        ctxGraph.lineWidth = 2;
                        ctxGraph.stroke();
                    }
                    lastPosX = avgX; lastPosY = avgY;

                    // ENVIO PARA FIREBASE A CADA 1 SEGUNDO (1000ms)
                    if (Date.now() - lastFirebaseTime > 1000) {
                        sendToFirebase(avgX, avgY);
                        lastFirebaseTime = Date.now();
                    }

                } else {
                    document.getElementById('status-detect').innerText = "OBJECT LOST";
                    document.getElementById('status-detect').style.color = "#DC3545";
                }

                if (Date.now() - lastResetTime > 10000) {
                    clearGraph();
                    lastResetTime = Date.now();
                }

                requestAnimationFrame(processFrame);
            } catch (e) {
                requestAnimationFrame(processFrame);
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SMC | CV Edge Analytics</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --smc-blue: #00529B;
            --smc-dark: #003366;
            --bg-body: #F0F2F5;
            --surface: #FFFFFF;
            --status-ok: #28A745;
            --border: #DEE2E6;
            --shadow: 0 2px 4px rgba(0,0,0,0.08);
            --radius: 6px;
        }

        /* LAYOUT BASE */
        html, body {
            height: 100vh; width: 100vw; margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: #212529; font-family: 'Inter', sans-serif;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* HEADER ESTILO DASHBOARD SMC */
        header {
            background: var(--surface);
            border-bottom: 3px solid var(--smc-blue);
            padding: 0.5rem 1rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow);
            flex: 0 0 auto;
        }

        .logo-container { display: flex; align-items: center; gap: 10px; }
        .logo-smc { height: 22px; }
        .header-title { font-size: 0.85rem; font-weight: 700; color: var(--smc-blue); text-transform: uppercase; }

        .protocol-badges { display: flex; gap: 5px; }
        .p-badge { 
            padding: 2px 6px; border-radius: 4px; background: #e9ecef; 
            color: #666; border: 1px solid #ced4da; font-size: 0.6rem; font-family: 'JetBrains Mono';
        }
        .p-badge.active { background: #d1e7dd; color: #0f5132; border-color: #badbcc; font-weight: bold; }

        /* GRID DE CONTEÚDO */
        main {
            flex: 1; display: flex; flex-direction: column;
            padding: 10px; gap: 10px; box-sizing: border-box;
        }

        .card {
            background: var(--surface); border-radius: var(--radius);
            box-shadow: var(--shadow); border: 1px solid var(--border);
            display: flex; flex-direction: column; flex: 1; overflow: hidden;
            position: relative;
        }

        .card-header {
            padding: 6px 12px; background: #F8F9FA;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-title { font-size: 0.7rem; font-weight: 700; color: var(--smc-dark); text-transform: uppercase; }

        .card-body { 
            flex: 1; position: relative; display: flex; 
            justify-content: center; align-items: center; background: #000;
        }

        canvas { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* VÍDEO HACK PARA MOBILE */
        #videoInput { position: absolute; opacity: 0; pointer-events: none; }

        /* FOOTER / KPI BLOCK */
        .kpi-footer {
            background: var(--surface); border-top: 1px solid var(--border);
            padding: 8px 15px; display: flex; justify-content: space-around;
            align-items: center; flex: 0 0 auto;
        }

        .kpi-item { border-left: 3px solid var(--smc-blue); padding-left: 10px; }
        .kpi-label { display: block; font-size: 0.6rem; color: #666; text-transform: uppercase; }
        .kpi-value { 
            font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; 
            font-weight: 700; color: var(--smc-blue);
        }
    </style>
</head>

<body>

    <header>
        <div class="logo-container">
            <img src="https://webmachines.com.br/uploads/produtos/580/614ccbd704751.png" alt="SMC" class="logo-smc">
            <span class="header-title">Vision Analytics</span>
        </div>
        <div class="protocol-badges">
            <span class="p-badge active" id="ai-status">CV: ACTIVE</span>
            <span class="p-badge">OPC-UA</span>
        </div>
    </header>

    <main>
        <div class="card">
            <div class="card-header">
                <span class="card-title">Live Stream: Sensor Feedback</span>
                <span class="p-badge">TAG: CAM_01</span>
            </div>
            <div class="card-body">
                <video id="videoInput" playsinline webkit-playsinline muted></video>
                <canvas id="canvasOutput"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">Trajectory Mapping (X-Y Axis)</span>
                <span class="p-badge">BUFFER: 4s</span>
            </div>
            <div class="card-body" style="background: #1a1a1a;">
                <canvas id="graphCanvas"></canvas>
            </div>
        </div>
    </main>

    <div class="kpi-footer">
        <div class="kpi-item">
            <span class="kpi-label">Eixo X</span>
            <span class="kpi-value" id="val-x">000</span>
        </div>
        <div class="kpi-item">
            <span class="kpi-label">Eixo Y</span>
            <span class="kpi-value" id="val-y">000</span>
        </div>
        <div class="kpi-item" style="border-left-color: var(--status-ok);">
            <span class="kpi-label">Status</span>
            <span class="kpi-value" id="status-detect" style="color: var(--status-ok); font-size: 0.8rem;">READY</span>
        </div>
    </div>

    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>

    <script>
        let video = document.getElementById('videoInput');
        let canvasOutput = document.getElementById('canvasOutput');
        let graphCanvas = document.getElementById('graphCanvas');
        let ctxGraph = graphCanvas.getContext('2d');
        
        let src, gray, circles, cap;
        let streaming = false;
        let historyX = [], historyY = [];
        const MOVING_AVG_SIZE = 6;
        let lastPosX = null, lastPosY = null, lastResetTime = Date.now();

        function onOpenCvReady() {
            document.getElementById('ai-status').innerText = "CV: READY";
            startCamera();
        }

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 640, height: 480 }, 
                audio: false 
            })
            .then(stream => {
                video.srcObject = stream;
                video.play();
            });

            video.addEventListener("playing", () => {
                if (!streaming) initProcessor();
            });
        }

        function initProcessor() {
            const w = video.videoWidth;
            const h = video.videoHeight;
            video.width = w; video.height = h;
            canvasOutput.width = w; canvasOutput.height = h;
            graphCanvas.width = w; graphCanvas.height = h;

            src = new cv.Mat(h, w, cv.CV_8UC4);
            gray = new cv.Mat(h, w, cv.CV_8UC1);
            circles = new cv.Mat();
            cap = new cv.VideoCapture(video);

            clearGraph();
            streaming = true;
            requestAnimationFrame(processFrame);
        }

        function clearGraph() {
            const w = graphCanvas.width;
            const h = graphCanvas.height;
            
            ctxGraph.fillStyle = "#1a1a1a";
            ctxGraph.fillRect(0, 0, w, h);
            
            // Grid Identidade SMC
            ctxGraph.strokeStyle = "#333";
            ctxGraph.lineWidth = 1;
            ctxGraph.font = "10px 'JetBrains Mono'";
            ctxGraph.fillStyle = "#666";

            // Linhas Horizontais e Valores Y
            for (let i = 0; i <= h; i += h/4) {
                ctxGraph.beginPath();
                ctxGraph.moveTo(0, i); ctxGraph.lineTo(w, i);
                ctxGraph.stroke();
                ctxGraph.fillText(Math.round(i), 5, i - 5);
            }

            // Linhas Verticais e Valores X
            for (let i = 0; i <= w; i += w/4) {
                ctxGraph.beginPath();
                ctxGraph.moveTo(i, 0); ctxGraph.lineTo(i, h);
                ctxGraph.stroke();
                ctxGraph.fillText(Math.round(i), i + 5, h - 5);
            }

            // Identificação dos Eixos
            ctxGraph.fillStyle = "#00529B";
            ctxGraph.fillText("EIXO X →", w - 60, h - 20);
            ctxGraph.fillText("EIXO Y ↓", 10, 20);

            lastPosX = null; lastPosY = null;
        }

        function processFrame() {
            if (!streaming) return;
            try {
                cap.read(src);
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                cv.medianBlur(gray, gray, 7);

                cv.HoughCircles(gray, circles, cv.HOUGH_GRADIENT, 1.2, 100, 150, 55, 10, 200);

                cv.imshow("canvasOutput", src);
                let ctxVideo = canvasOutput.getContext("2d");

                if (circles.cols > 0) {
                    let rawX = circles.data32F[0];
                    let rawY = circles.data32F[1];
                    let radius = circles.data32F[2];

                    historyX.push(rawX); historyY.push(rawY);
                    if (historyX.length > MOVING_AVG_SIZE) { historyX.shift(); historyY.shift(); }

                    let avgX = historyX.reduce((a, b) => a + b) / historyX.length;
                    let avgY = historyY.reduce((a, b) => a + b) / historyY.length;

                    // Update UI Coords
                    document.getElementById('val-x').innerText = Math.round(avgX).toString().padStart(3, '0');
                    document.getElementById('val-y').innerText = Math.round(avgY).toString().padStart(3, '0');
                    document.getElementById('status-detect').innerText = "TRACKING";

                    // Desenha no vídeo
                    ctxVideo.beginPath();
                    ctxVideo.arc(avgX, avgY, radius, 0, Math.PI * 2);
                    ctxVideo.strokeStyle = "#28A745";
                    ctxVideo.lineWidth = 4;
                    ctxVideo.stroke();

                    // Trajetória no gráfico
                    if (lastPosX !== null) {
                        ctxGraph.beginPath();
                        ctxGraph.moveTo(lastPosX, lastPosY);
                        ctxGraph.lineTo(avgX, avgY);
                        ctxGraph.strokeStyle = "#00529B"; // Azul SMC para a linha
                        ctxGraph.lineWidth = 3;
                        ctxGraph.stroke();
                    }
                    lastPosX = avgX; lastPosY = avgY;
                } else {
                    document.getElementById('status-detect').innerText = "SCANNING";
                }

                if (Date.now() - lastResetTime > 4000) {
                    clearGraph();
                    lastResetTime = Date.now();
                }

                requestAnimationFrame(processFrame);
            } catch (e) {
                requestAnimationFrame(processFrame);
            }
        }
    </script>
</body>
</html>
